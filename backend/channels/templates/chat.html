<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Chat</title>
        <link rel="stylesheet" href="../static/styles.css">
    </head>
    <body>
<div class="chat-container">
  <div class="user-list" id="user_list">
      <div class="current-user">

      </div>
    <h2>Все пользователи</h2>
    <ul>
    </ul>
  </div>

    <div class="chat-window">
      <div class="chat-header">
        <h2><span>Чат не выбран</span></h2>
      </div>

    <div class="chat-body">
        <textarea class="message-item" id="chat-log" cols="100" rows="20"></textarea><br>
    </div>

    <div class="chat-footer">
    <input class="message-input" id="chat-message-input" type="text" placeholder="Напишите сообщение..."><br>
    <input class="send-button" id="chat-message-submit" type="button" value="Send">
    </div>
</div>
</div>

        <script>
            const userList = document.getElementById('user_list');
            const chatHeader = document.querySelector('.chat-header h2 span');
            const messageList = document.querySelector('.message-list');
            const messageInput = document.querySelector('.message-input');
            const sendButton = document.querySelector('.send-button');

let selectedUserId = 0;
function populateUsers(users){
    users.forEach((user) =>{
        let newElementUserItem = document.createElement("li")
        let textNode = document.createTextNode(user.username);
        newElementUserItem.id = user._id;
        newElementUserItem.className = "user-item";
        newElementUserItem.appendChild(textNode);
        userList.appendChild(newElementUserItem);
        newElementUserItem.addEventListener("click", () => {
            chooseUser(newElementUserItem)
        })
    })
}
function displayCurrentUser(user_data){
    const currentUser = document.querySelector('.current-user')
    currentUser.innerHTML = `Привет ${user_data.username}`
}
let chooseUser = function(newElementUserItem) {
        const allUsers = document.querySelectorAll('.user-item');
        const userId = newElementUserItem.getAttribute("id");
        const userName = newElementUserItem.textContent
        if (userId !== selectedUserId) {
            allUsers.forEach((user) => {
                if (user.id !== newElementUserItem) {
                    user.classList.remove('active');
                }
            });
            selectedUserId = userId;
            newElementUserItem.classList.add('active');
            chatHeader.textContent = `Чат с пользователем ${userName}`;
        }
}


            const tokensArray = document.cookie.split(';')
            let access_token = tokensArray[0].trim()
            let refresh_token = tokensArray[1].trim()
            const ws = new WebSocket(`ws://localhost:8000/ws/chat?${access_token}`);
            ws.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log(data)
                if (data.message) {
                    document.querySelector('#chat-log').value += (data.message) + '\n';
                }
                else if(data.users){
                    populateUsers(data.users)
                }
                else if(data.user){
                    displayCurrentUser(data.user)
                }
            };
            ws.onclose = function(e) {
                console.error('ws closed');
            };
            ws.onconnect = function(e){

            }
            document.querySelector('#chat-message-input').focus();
            document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
            document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            ws.send(JSON.stringify({
                "message": message
            }));
            messageInputDom.value = '';
        };
};
        </script>
    </body>
</html>